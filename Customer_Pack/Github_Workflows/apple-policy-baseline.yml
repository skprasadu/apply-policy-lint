name: Apple Policy Lint - Update baseline

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  baseline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Preflight (config)
        id: preflight
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f .p2i/config.json ]; then
            msg="Missing .p2i/config.json. Add it to the repo and re-run baseline."
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "::error title=Apple Policy Lint setup required::$msg"

            {
              echo "## Apple Policy Lint - Baseline"
              echo ""
              echo "âŒ $msg"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "ok=true" >> "$GITHUB_OUTPUT"

      - name: Fail fast if preflight failed
        if: steps.preflight.outputs.ok != 'true'
        shell: bash
        run: exit 1

      - name: Start timer
        if: steps.preflight.outputs.ok == 'true'
        shell: bash
        run: echo "START_TS=$(date +%s)" >> "$GITHUB_ENV"

      - name: Run Apple Policy Lint (full scan -> baseline)
        if: steps.preflight.outputs.ok == 'true'
        id: apl
        uses: skprasadu/apple-policy-lint@v0.2.2
        with:
          root: .
          scan: full
          comment: "false"
          github_annotations: "false"
          fail_on_issues: "false"
          config_path: .p2i/config.json
          report_json: .p2i/baseline.json
          report_md: out/baseline.md

      - name: Stop timer + summarize
        if: always() && steps.preflight.outputs.ok == 'true'
        shell: bash
        run: |
          set -euo pipefail
          end=$(date +%s)
          elapsed=$(( end - START_TS ))
          findings="${{ steps.apl.outputs.count }}"

          {
            echo "## Apple Policy Lint - Baseline"
            echo ""
            echo "- Mode: **full**"
            echo "- Findings captured in baseline: **${findings:-unknown}**"
            echo "- Elapsed: **${elapsed}s**"
            echo ""
            echo "Baseline path: \`.p2i/baseline.json\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Create PR with baseline update
        if: steps.preflight.outputs.ok == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(policy): update apple-policy-lint baseline"
          title: "chore(policy): update apple-policy-lint baseline"
          body: |
            This PR updates `.p2i/baseline.json` using apple-policy-lint full scan.
          base: ${{ github.ref_name }}
          branch: chore/apple-policy-baseline/${{ github.ref_name }}
          delete-branch: true
          add-paths: |
            .p2i/baseline.json

      - name: Upload baseline report (optional)
        if: always() && steps.preflight.outputs.ok == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: apple-policy-baseline-report
          path: |
            .p2i/baseline.json
            out/baseline.md